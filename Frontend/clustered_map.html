<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clustered Map – Gulf States Only</title>
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/geodata/usaLow.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
    }
    #chartdiv {
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
  <div id="chartdiv"></div>

  <script>
    // Create root element
    var root = am5.Root.new("chartdiv");

    // Set themes
    root.setThemes([am5themes_Animated.new(root)]);

    // Create the map chart
    var chart = root.container.children.push(
      am5map.MapChart.new(root, {
        panX: "translateX",
        panY: "translateY",
        projection: am5map.geoAlbersUsa()
      })
    );

    chart.set("zoomControl", am5map.ZoomControl.new(root, {}));

    // Create main polygon series for USA map
    var polygonSeries = chart.series.push(
      am5map.MapPolygonSeries.new(root, {
        geoJSON: am5geodata_usaLow,
        include: [
          "US-TX", "US-LA", "US-MS", "US-AL", "US-FL"
        ]
      })
    );

    polygonSeries.mapPolygons.template.setAll({
      fill: am5.color(0xdadada),
      stroke: am5.color(0x999999)
    });

    // Create point series for clustered markers
    var pointSeries = chart.series.push(
      am5map.ClusteredPointSeries.new(root, {
        groupIdField: "state"
      })
    );

    // Clustered bullet visuals
    pointSeries.set("clusteredBullet", function (root) {
      var container = am5.Container.new(root, {
        cursorOverStyle: "pointer"
      });

      container.children.push(am5.Circle.new(root, {
        radius: 8,
        tooltipY: 0,
        fill: am5.color(0xff8c00)
      }));

      container.children.push(am5.Circle.new(root, {
        radius: 12,
        fillOpacity: 0.3,
        tooltipY: 0,
        fill: am5.color(0xff8c00)
      }));

      container.children.push(am5.Circle.new(root, {
        radius: 16,
        fillOpacity: 0.3,
        tooltipY: 0,
        fill: am5.color(0xff8c00)
      }));

      container.children.push(am5.Label.new(root, {
        centerX: am5.p50,
        centerY: am5.p50,
        fill: am5.color(0xffffff),
        populateText: true,
        fontSize: "8",
        text: "{value}"
      }));

      container.events.on("click", function (e) {
        pointSeries.zoomToCluster(e.target.dataItem);
      });

      return am5.Bullet.new(root, {
        sprite: container
      });
    });

    // Regular individual bullets
    pointSeries.bullets.push(function () {
      return am5.Bullet.new(root, {
        sprite: am5.Circle.new(root, {
          radius: 6,
          tooltipY: 0,
          fill: am5.color(0xff8c00),
          tooltipText: "{title} ({state})"
        })
      });
    });

    // ========================================
    // DATA: TEAM RUBICON DEPLOYMENTS
    // ========================================
    fetch("../Data/map_points.json")
      .then(res => res.json())
      .then(jsonData => {
        const gulfStates = new Set(["US-TX", "US-LA", "US-MS", "US-AL", "US-FL"]);
        jsonData.forEach(d => {
          const deployments = Number(d["# of Deployments"]);
          if (gulfStates.has("US-" + d.state_id) && deployments > 0) {
            pointSeries.data.push({
              geometry: { type: "Point", coordinates: [d.lng, d.lat] },
              title: `${d.city}, ${d.state_id} — ${deployments} deployments`,
              city: d.city,
              state: d.state_id,
              value: deployments
            });
          }
        });
      });

    // Animate on load
    chart.appear(1000, 100);
  </script>
</body>
</html>
