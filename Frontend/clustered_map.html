<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clustered Map – Gulf States Only</title>
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/geodata/usaLow.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
    }
    #chartdiv {
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
  <div id="chartdiv"></div>

  <script>
    var root = am5.Root.new("chartdiv");

    root.setThemes([am5themes_Animated.new(root)]);

    var chart = root.container.children.push(
      am5map.MapChart.new(root, {
        panX: "translateX",
        panY: "translateY",
        projection: am5map.geoAlbersUsa()
      })
    );

    chart.set("zoomControl", am5map.ZoomControl.new(root, {}));

    var polygonSeries = chart.series.push(
      am5map.MapPolygonSeries.new(root, {
        geoJSON: am5geodata_usaLow,
        include: ["US-TX", "US-LA", "US-MS", "US-AL", "US-FL"]
      })
    );

    polygonSeries.mapPolygons.template.setAll({
      fillOpacity: 0,
      stroke: am5.color(0x999999)
    });

    var pointSeries = chart.series.push(
      am5map.ClusteredPointSeries.new(root, {
        groupIdField: "state"
      })
    );

    pointSeries.set("clusteredBullet", function (root) {
      var container = am5.Container.new(root, {
        cursorOverStyle: "pointer"
      });

      container.children.push(am5.Circle.new(root, {
        radius: 8,
        tooltipY: 0,
        fill: am5.color(0xff8c00)
      }));

      container.children.push(am5.Circle.new(root, {
        radius: 12,
        fillOpacity: 0.3,
        tooltipY: 0,
        fill: am5.color(0xff8c00)
      }));

      container.children.push(am5.Circle.new(root, {
        radius: 16,
        fillOpacity: 0.3,
        tooltipY: 0,
        fill: am5.color(0xff8c00)
      }));

      container.children.push(am5.Label.new(root, {
        centerX: am5.p50,
        centerY: am5.p50,
        fill: am5.color(0xffffff),
        populateText: true,
        fontSize: "8",
        text: "{value}"
      }));

      container.events.on("click", function (e) {
        pointSeries.zoomToCluster(e.target.dataItem);
      });

      return am5.Bullet.new(root, { sprite: container });
    });

    pointSeries.bullets.push(function () {
      return am5.Bullet.new(root, {
        sprite: am5.Circle.new(root, {
          radius: 6,
          tooltipY: 0,
          fill: am5.color(0xff8c00),
          tooltipText: "{title} ({state})"
        })
      });
    });

    // ===============================
    // Load deployment point data
    // ===============================
    fetch("../Data/map_points.json")
      .then(res => res.json())
      .then(jsonData => {
        const gulfStates = new Set(["US-TX", "US-LA", "US-MS", "US-AL", "US-FL"]);
        jsonData.forEach(d => {
          const deployments = Number(d["# of Deployments"]);
          if (gulfStates.has("US-" + d.state_id) && deployments > 0) {
            pointSeries.data.push({
              geometry: { type: "Point", coordinates: [d.lng, d.lat] },
              title: `${d.city}, ${d.state_id} — ${deployments} deployments`,
              city: d.city,
              state: d.state_id,
              value: deployments
            });
          }
        });
      });

    // ===============================
    // Load and render county outlines
    // ===============================
    fetch("../Data/county-level-geo.json")
        .then(res => res.json())
        .then(geo => {
            const gulfFIPS = ["01", "12", "22", "28", "48"];

            geo.features = geo.features.filter(f => 
                gulfFIPS.includes(String(f.properties.STATE).padStart(2, "0"))
            );

            console.log("County features loaded:", geo.features.length);

            const countySeries = am5map.MapPolygonSeries.new(root, {
                geoJSON: geo
            });

            countySeries.mapPolygons.template.setAll({
                fillOpacity: 0,
                stroke: am5.color(0x000000),  // stronger line
                strokeWidth: 1,
                interactive: false,
                cursorOverStyle: "default",
                visible: true
            });
            countySeries.mapPolygons.template.adapters.add("pointerEvents", () => "none");
            countySeries.mapPolygons.template.set("tooltipText", "{NAME} County");

            chart.series.insertIndex(1, countySeries); 
        });

    chart.appear(1000, 100);
  </script>
</body>
</html>
